window.__require=function e(t,i,o){function n(s,c){if(!i[s]){if(!t[s]){var r=s.split("/");if(r=r[r.length-1],!t[r]){var h="function"==typeof __require&&__require;if(!c&&h)return h(r,!0);if(a)return a(r,!0);throw new Error("Cannot find module '"+s+"'")}}var l=i[s]={exports:{}};t[s][0].call(l.exports,function(e){return n(t[s][1][e]||e)},l,l.exports,e,t,i,o)}return i[s].exports}for(var a="function"==typeof __require&&__require,s=0;s<o.length;s++)n(o[s]);return n}({Direction:[function(e,t,i){"use strict";cc._RF.push(t,"d0eff53TABBdp93UM4nVaju","Direction"),t.exports={up:0,left:1,down:2,right:3},cc._RF.pop()},{}],Game:[function(e,t,i){"use strict";cc._RF.push(t,"7a0adax1tRDI4wOp3m0SWH4","Game");var o=e("./utils/config"),n=e("Gem"),a=(n.GemColor,n.GemType);cc.Class({extends:cc.Component,properties:{map:{default:[],visible:!1},colorMap:{default:[],visible:!1},width:o.map_width,height:o.map_height,wall:{default:null,type:cc.Node,tooltip:"\u5b9d\u77f3\u6240\u5904\u7684\u5899"},gems:{default:[],type:[cc.Prefab],tooltip:"\u5b9d\u77f3\u6570\u7ec4"},superGem:{default:null,type:cc.Prefab,tooltip:"\u8d85\u80fd\u5b9d\u77f3"},gem_spacing:{default:74,tooltip:"\u5b9d\u77f3\u95f4\u8ddd"},scoreOnBoard:{type:cc.Label,default:null,tooltip:"\u5f53\u524d\u5f97\u5206"},scoreOnGem:{type:cc.Prefab,default:null,tooltip:"\u5339\u914d\u5f97\u5206"},basisPoints:{default:5,tooltip:"\u6d88\u9664\u6bcf\u4e2a\u5b9d\u77f3\u5f97\u5206"},chainTime:{default:3,tooltip:"\u8fde\u51fb\u6709\u6548\u65f6\u95f4"},checkTime:{default:.1,tooltip:"\u68c0\u67e5\u65f6\u95f4"},nowChainLabel:{default:null,type:cc.Label,tooltip:"\u5f53\u524d\u8fde\u51fb\u5c55\u793a\u6846"},maxChainLabel:{default:null,type:cc.Label,tooltip:"\u6700\u5927\u8fde\u51fb\u5c55\u793a\u6846"},chainTimeLeftLebel:{default:null,type:cc.Label,tooltip:"\u8fde\u51fb\u5269\u4f59\u65f6\u95f4\u5c55\u793a\u6846"}},onLoad:function(){this.nowChain=0,this.maxChain=0,this.scoreNumber=0;for(var e=0;e<this.height;e++){this.map[e]=[],this.colorMap[e]=[];for(var t=0;t<2*this.width;t++)this.colorMap[e][t]=-1}this.makeGem(1)},start:function(){this.schedule(function(){0==this.nowChain&&(this.chainTimeLeft=0),this.chainTimeLeft-=this.checkTime,this.chainTimeLeft=this.chainTimeLeft.toFixed(1),this.chainTimeLeft<=0&&(this.nowChain=0,this.chainTimeLeft=0),this.nowChainLabel.string="NowChain: "+this.nowChain.toString(),this.maxChainLabel.string="MaxChain: "+this.maxChain.toString(),this.chainTimeLeftLebel.string="ChainTimeLeft: "+this.chainTimeLeft.toString()},this.checkTime)},randomNumber:function(e,t){return null===e||null===t?(cc.error("null param"),0):parseInt(Math.random()*(t-e+1)+e,10)},createGem:function(e){return cc.instantiate(e)},setGem:function(e,t,i){if(void 0!==i){i.parent=this.wall;var o=i.getComponent("Gem"),n=this.gem_spacing;i.setPosition(e*n-256,t*n-253),this.map[e][t]=i,this.colorMap[e][t]=o.color}else cc.error("gem is null")},checkColor:function(e,t,i,o){if(e<0||t<0||e>=this.width||t>=2*this.height)return cc.error("input invalid"),!1;void 0===i&&(i=this.colorMap[e][t]);var n=function(e,t,i){return e===t&&e===i},a=!1,s=this.colorMap,c=e,r=t;return c-2>=0&&n(s[c-1][r],s[c-2][r],i)&&(a=!0),c+2<this.width&&n(s[c+1][r],s[c+2][r],i)&&(a=!0),r-2>=0&&n(s[c][r-1],s[c][r-2],i)&&(a=!0),c+2<this.height&&n(s[c][r+1],s[c][r+2],i)&&(a=!0),void 0!==o&&o(a),a},getGem:function(e,t){return e<0||t<0||e>=this.map.length||t>=this.map[e].length?void 0:this.map[e][t]},getNodePosition:function(e){var t=this.map,i=void 0,o=void 0;for(i=0;i<t.length&&!((o=t[i].indexOf(e))>-1);i++);return{x:i,y:o}},swapGem:function(e,t){var i=e.getComponent("Gem").getMapPosition(),o=t.getComponent("Gem").getMapPosition(),n=this.map[i.x][i.y];this.map[i.x][i.y]=this.map[o.x][o.y],this.map[o.x][o.y]=n,n=this.colorMap[i.x][i.y],this.colorMap[i.x][i.y]=this.colorMap[o.x][o.y],this.colorMap[o.x][o.y]=n},makeGem:function(e){for(var t=this.gems.length,i=1==e?0:this.height,o=0;o<this.width;o++)for(var n=i;n<2*this.height;n++)if(-1==this.colorMap[o][n]){this.colorMap[o][n]=this.randomNumber(0,t-2);for(var a=this.colorMap[o][n];this.checkColor(o,n,a);)a=this.randomNumber(0,t-2);this.colorMap[o][n]=a;var s=this.gems[a],c=this.createGem(s);this.setGem(o,n,c),n>=this.height&&(c.opicity=0)}},makeSPGem:function(e){if(!(3!=e.tag&&e.maxMatch<=3)){this.colorMap[e.x][e.y]=e.color;var t=this.gems[e.color],i=this.createGem(t),o=i.getComponent("Gem");o.color=e.color,3==e.tag?(o.type=a.LIGHT,i.getChildByName("Lights").active=!0,cc.log("LIGHT")):4==e.maxMatch?(o.type=a.FLAME,i.getChildByName("Flames").active=!0,cc.log("FLAME")):5==e.maxMatch?(o.type=a.SUPER,i.destroy(),i=this.createGem(this.superGem),cc.log("SUPER")):e.maxMatch>=6?(o.type=a.STARS,i.getChildByName("Stars").active=!0,cc.log("STARS")):(cc.error("invalid SP gem"),cc.log(e)),this.setGem(e.x,e.y,i)}},addScore:function(e,t){var i=t*this.basisPoints;this.scoreNumber+=i*(this.nowChain+1),this.scoreOnBoard.string="Score: "+this.scoreNumber.toString()},addChain:function(){this.nowChain++,this.maxChain=Math.max(this.nowChain,this.maxChain),this.chainTimeLeft=this.chainTime,this.nowChainLabel.string="NowChain: "+this.nowChain.toString(),this.maxChainLabel.string="MaxChain: "+this.maxChain.toString(),this.chainTimeLeftLebel.string="ChainTimeLeft: "+this.chainTimeLeft.toString()}}),cc._RF.pop()},{"./utils/config":"config",Gem:"Gem"}],GemManager:[function(e,t,i){"use strict";cc._RF.push(t,"e6ffec0QRhNjrl9M5TXk85z","GemManager");e("../utils/config");var o=null;cc.Class({extends:cc.Component,properties:{chosenOutline:{default:null,type:cc.Prefab,tooltip:"\u9009\u4e2d\u65f6\u8fb9\u6846"},selectedGems:{get:function(){return this._selectedGems},set:function(e){null===o&&((o=cc.instantiate(this.chosenOutline)).parent=this.node),void 0===this._selectedGems&&(this._selectedGems=[]);var t=this._selectedGems;if(e.getComponent("Gem").selected=!0,t.push(e),2===t.length)this.isNear(t[0],t[1])&&this.swapGem(t[0],t[1]),t[0].getComponent("Gem").selected=!1,t.shift(),t.shift(),o.opacity=0;else{var i=t[0].getComponent("Gem").getPosition();o.opacity=255,o.setPosition(i.x,i.y)}},visible:!1},debug:{type:cc.Prefab,default:null,tooltip:"picture for debug"},moveTime:{default:.2,tooltip:"\u5b9d\u77f3\u79fb\u52a8\u65f6\u95f4"},fallTime:{default:.3,tooltip:"\u4e0b\u843d\u65f6\u95f4"}},gemSelected:function(e){this.selectedGems=e},swapGem:function(e,t){var i=e.getComponent("Gem"),o=t.getComponent("Gem");i.GemMoving=!0,o.GemMoving=!0;var n=this.node.getComponent("Game"),a=5==i.type,s=5==o.type;if(a&&s){var c=this.clearColor(-1);n.addScore(e.getPosition(),c)}else if(a&&!s){var r=this.clearColor(o.color);n.addScore(t.getPosition(),r),this.delGem(e)}else if(!a&&s){var h=this.clearColor(i.color);n.addScore(e.getPosition(),h),this.delGem(t)}else n.swapGem(e,t),this._checkGemMap(e,t)?(n.addChain(),this._swapGemValid(e,t),this.scheduleOnce(function(){this.clearGem(e),(t.isValid||o.GemDeleting)&&this.clearGem(t),this.GemFall()},2*this.moveTime)):(this._swapGemInvalid(e,t),n.swapGem(e,t));this.scheduleOnce(function(){i.GemMoving=!1,o.GemMoving=!1},2*this.moveTime)},_checkGemMap:function(e,t){var i=0;return i|=this.matchDetect(e).tag,i|=this.matchDetect(t).tag},isNear:function(e,t){var i=e.getComponent("Gem"),o=t.getComponent("Gem");if(i.GemFalling||i.GemMoving)return!1;if(o.GemFalling||o.GemMoving)return!1;var n=this.node.getComponent("Game"),a=n.getNodePosition(e),s=n.getNodePosition(t);return null!==a&&null!=s||cc.error("\u627e\u4e0d\u5230\u4f4d\u7f6e"),Math.abs(a.x-s.x)+Math.abs(a.y-s.y)===1},_swapGemInvalid:function(e,t){var i=this.moveTime,o=e.getComponent("Gem"),n=t.getComponent("Gem"),a=o.getPosition(),s=n.getPosition(),c=cc.moveTo(i,a),r=cc.moveTo(i,s),h=cc.delayTime(.1),l=cc.sequence(r,h,c),m=cc.sequence(c,h,r);e.zIndex=1,e.runAction(l),t.runAction(m),e.zIndex=0},_swapGemValid:function(e,t){var i=this.moveTime,o=e.getComponent("Gem"),n=t.getComponent("Gem"),a=o.getPosition(),s=n.getPosition(),c=cc.moveTo(i,a),r=cc.moveTo(i,s);e.zIndex=1,e.runAction(r),t.runAction(c),e.zIndex=0},clearGem:function(e){if(void 0!=e&&null!=e&&0!=e.isValid&&!e.getComponent("Gem").GemDeleting){var t=this.node.getComponent("Game"),i=(t.colorMap,t.getNodePosition(e)),o=i.x,n=i.y;if(!(n>=t.height)){var a=this.matchDetect(e);if(null==a){var s=cc.instantiate(this.debug);return s.parent=this.node,void s.setPosition(e.getPosition())}var c=a.tag,r=a.up,h=a.down,l=a.left,m=a.right,p=a.maxMatch;if(2&c)for(var u=h+1;u<r;u++)this.delGem(t.getGem(o,u));if(1&c)for(var g=l+1;g<m;g++)this.delGem(t.getGem(g,n));p>=3&&n<t.height&&t.addScore(e.getPosition(),p),n<t.height&&t.makeSPGem(a)}}},matchDetect:function(e){if(void 0==e||null==e)return null;var t=this.node.getComponent("Game"),i=e.getComponent("Gem");if(1==i.GemDeleting)return null;var o=t.colorMap,n=t.getNodePosition(e),a=n.x,s=n.y;if(-1==a||-1==s)return cc.error(n),null;for(var c=0,r=s,h=s;h>=0&&o[a][h]==o[a][s];)h--;for(;r<o[a].length/2&&o[a][r]==o[a][s];)r++;r-h>=4&&(c|=2);for(var l=a,m=a;l>=0&&o[l][s]==o[a][s];)l--;for(;m<o.length&&o[m][s]==o[a][s];)m++;m-l>=4&&(c|=1),-1==o[a][s]&&(c=0);var p=Math.max(r-h,m-l)-1;return{x:a,y:s,tag:c,up:r,down:h,left:l,right:m,color:i.getColor(),maxMatch:p}},GemFallDetect:function(){for(var e=this.node.getComponent("Game").colorMap,t=[],i=0;i<e.length;i++){t[i]=[];for(var o=0;o<e[i].length;o++)t[i][o]=0==o?0:t[i][o-1],-1==e[i][o]&&t[i][o]++}return t},GemFall:function(){for(var e=this,t=this.GemFallDetect(),i=this.node.getComponent("Game"),o=i.colorMap,n=0;n<t.length;n++)for(var a=0;a<t[n].length;a++){if(0!=t[n][a]&&-1!=o[n][a])if("continue"===function(){var s=i.getGem(n,a);if(null==s||void 0==s)return cc.error("null!!"),"continue";var c=s.getComponent("Gem");c.GemFalling=!0,a-t[n][a]<i.width?s.opacity=255:s.opacity=0;var r=cc.moveBy(e.fallTime,0,-1*i.gem_spacing*t[n][a]);s.runAction(r),i.colorMap[n][a-t[n][a]]=o[n][a],i.colorMap[n][a]=-1,i.map[n][a-t[n][a]]=s,e.scheduleOnce(function(){c.GemFalling=!1,i.makeGem(2),c.GemDeleting||(this.clearGem(s),this.scheduleOnce(function(){this.GemFall()},1.5*this.moveTime))},1.5*e.fallTime)}())continue}},delGem:function(e){if(void 0!=e&&null!=e&&null!=e.parent){var t=e.getComponent("Gem"),i=this.node.getComponent("Game");if(1!=t.GemDeleting){t.GemDeleting=!0;var o=t.getMapPosition();if(1==t.type){for(var n=0;n<i.colorMap.length;n++)n!=o.y&&this.delGem(i.getGem(o.x,n)),n!=o.y&&this.delGem(i.getGem(n,o.y));i.addScore(e.getPosition(),i.width+i.height-1)}else if(4==t.type){for(n=-1;n<=1;n++)for(var a=-1;a<=1;a++)0!=n&&0!=a&&this.delGem(i.getGem(o.x+n,o.y+a));i.addScore(e.getPosition(),9)}else if(5==t.type){var s=i.gems.length;i.addScore(e.getPosition(),this.clearColor(i.randomNumber(0,s-2)))}else if(6==t.type){for(n=0;n<i.colorMap.length;n++)for(a=-1;a<=1;a++)o.x+a>=0&&o.x+a<i.width&&n!=o.y&&this.delGem(i.getGem(o.x+a,n)),o.y+a>=0&&o.y+a<i.height&&n!=o.x&&this.delGem(i.getGem(n,o.y+a));i.addScore(e.getPosition(),3*(this.width+this.height)-9)}i.colorMap[o.x][o.y]=-1,e.destroy()}else this.scheduleOnce(function(){1==e.isValid&&e.destroy()},1)}},clearColor:function(e){for(var t=this.node.getComponent("Game"),i=t.map,o=0,n=0;n<t.width;n++)for(var a=0;a<t.height;a++){i[n][a].getComponent("Gem").getColor()!=e&&-1!==e||(this.delGem(i[n][a]),o++)}return this.GemFall(),cc.log(t.colorMap),cc.log(t.map),o}}),cc._RF.pop()},{"../utils/config":"config"}],Gem:[function(e,t,i){"use strict";cc._RF.push(t,"00cecvuQoVIRLnlCT9zrswR","Gem");e("./Gem/Direction");var o=cc.Enum({WHITE:0,BLUE:1,RED:2,GREEN:3,ORANGE:4,YELLOW:5,PURPLE:6,SUPER:-7}),n=cc.Enum({NORMAL:0,LIGHT:1,FLAME:4,SUPER:5,STARS:6});cc.Class({extends:cc.Component,properties:{color:{default:o.WHITE,type:o,tooltip:"\u8f93\u5165\u989c\u8272\u7c7b\u578b"},type:{default:n.NORMAL,type:n,tooltip:"\u5b9d\u77f3\u7c7b\u578b"},gemSize:{default:60,tooltip:"\u5b9d\u77f3\u5927\u5c0f"},selected:{get:function(){return this._selected},set:function(e){this._selected=e}}},start:function(){this._wall=this.node.parent,this.game=this._wall.getComponent("Game"),this.GemMoving=!1,this.GemFalling=!1,this.getMapPosition().y>=this.game.width&&(this.node.opacity=0)},onLoad:function(){this.GemMoving=!1,this.GemFalling=!1,this.GemDeleting=!1,this.node.on("touchend",function(e){(this.type!=n.NORMAL&&cc.log(this.getMapPosition()),this.GemMoving||this.GemFalling||this.GemDeleting)||this._wall.getComponent("GemManager").gemSelected(this.node)},this)},getPosition:function(){return this.node.getPosition()},getMapPosition:function(){return this.game.getNodePosition(this.node)},getColor:function(){return this.color},getType:function(){return this.type}}),t.exports={GemColor:o,GemType:n},cc._RF.pop()},{"./Gem/Direction":"Direction"}],ScoreLabel:[function(e,t,i){"use strict";cc._RF.push(t,"3ba2b5IbTBOF5jKUF4a7v1H","ScoreLabel"),cc.Class({extends:cc.Component,properties:{existTime:{default:.1,tooltip:"\u5b58\u5728\u65f6\u95f4"},moveDistance:{default:100,tooltip:"\u79fb\u52a8\u8ddd\u79bb"}},start:function(){cc.log(111),this.scheduleOnce(function(){this.node.destroy()},1.2*this.existTime)}}),cc._RF.pop()},{}],config:[function(e,t,i){"use strict";cc._RF.push(t,"b3621Jtct9K2LzguiXftjCW","config");t.exports={map_width:8,map_height:8},cc._RF.pop()},{}]},{},["Game","Gem","GemManager","Direction","ScoreLabel","config"]);